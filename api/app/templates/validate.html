{% extends "base.html" %}
{% block content %}

<div class="card">
  <h2>Validate Import</h2>

  {% if force_unbalanced_warning %}
    <div class="warn">
      <b>TB does not net to zero.</b> Check your mapping, delimiter, headers, and amounts.
      If you still want to continue, check “Allow unbalanced” and continue.
    </div>
  {% endif %}

  <div class="card">
    <p><b>Total net:</b> {{ report.total_net }}</p>
    <p><b>Nets to zero (±{{ tolerance }}):</b> {{ "YES" if nets_to_zero else "NO" }}</p>
  </div>

  <div class="card">
    <h3>Detected Funds</h3>
    <table>
      <thead>
        <tr>
          <th>Fund</th>
          <th>Rows</th>
        </tr>
      </thead>
      <tbody>
        {% for code, cnt in report.fund_counts.items() %}
        <tr>
          <td>{{ code }}</td>
          <td>{{ cnt }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <form action="/tb/funds" method="post">
    <!-- CRITICAL: carry wizard state forward exactly -->
    <input type="hidden" name="upload_id" value="{{ upload_id }}">
    <input type="hidden" name="has_headers" value="{{ 1 if has_headers else 0 }}">
    <input type="hidden" name="delimiter" value="{{ delimiter }}">
    <input type="hidden" name="header_row" value="{{ header_row }}">

    <!-- mapping carry-forward -->
    <input type="hidden" name="account_col" value="{{ mapping.account_col }}">
    <input type="hidden" name="desc_col" value="{{ mapping.desc_col or '' }}">
    <input type="hidden" name="amount_mode" value="{{ mapping.mode }}">
    <input type="hidden" name="balance_col" value="{{ mapping.balance_col or '' }}">
    <input type="hidden" name="debit_col" value="{{ mapping.debit_col or '' }}">
    <input type="hidden" name="credit_col" value="{{ mapping.credit_col or '' }}">
    <input type="hidden" name="fund_mode" value="{{ mapping.fund_mode }}">
    <input type="hidden" name="fund_col" value="{{ mapping.fund_col or '' }}">
    <input type="hidden" name="fund_delimiter" value="{{ mapping.fund_delimiter }}">

    {% if not nets_to_zero %}
      <div style="margin:10px 0;">
        <label>
          <input type="checkbox" name="allow_unbalanced" value="on">
          Allow unbalanced and continue anyway
        </label>
      </div>
    {% endif %}

    <button class="btn btn-primary" type="submit">Continue</button>
    <a class="btn" href="/">Start Over</a>
  </form>
</div>

{% endblock %}
