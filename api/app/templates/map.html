{% extends "base.html" %}
{% block content %}

<div class="card">
  <h2>Map Columns</h2>
  <p><b>File:</b> {{ filename }}</p>

  <div class="warn" style="margin-top:10px;">
    <b>Tip:</b> If the preview looks wrong, re-upload the Excel file and confirm the first row is your header row.
  </div>

  <h3 style="margin-top:16px;">Preview</h3>
  <table>
    <thead>
      <tr>
        {% for h in headers %}
          <th>{{ h }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        {% for h in headers %}
          <td>{{ r.get(h, "") }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="card">
  <h2>Choose Your Columns</h2>

  <form action="/tb/validate" method="post">
    <!-- carry wizard state forward -->
    <input type="hidden" name="upload_id" value="{{ upload_id }}">
    <input type="hidden" name="has_headers" value="{{ 1 if has_headers else 0 }}">
    <input type="hidden" name="delimiter" value="{{ delimiter }}">
    <input type="hidden" name="header_row" value="{{ header_row }}">

    <div class="row">
      <div class="col">
        <label><b>Account column</b></label><br>
        <select name="account_col" required>
          {% for h in headers %}
            <option value="{{ h }}">{{ h }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col">
        <label><b>Description column</b></label><br>
        <select name="desc_col" required>
          {% for h in headers %}
            <option value="{{ h }}">{{ h }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col">
        <label><b>Fund identification</b></label><br>
        <select name="fund_mode" id="fund_mode" required>
          <option value="fund_from_account_prefix" selected>Derive from account prefix (e.g., 10-1010)</option>
          <option value="fund_column">Use a fund column</option>
          <option value="single_fund">Single fund (no fund breakdown)</option>
        </select>

        <div id="fund_col_wrap" style="margin-top:8px; display:none;">
          <label>Fund column</label><br>
          <select name="fund_col">
            <option value="" selected>(select)</option>
            {% for h in headers %}
              <option value="{{ h }}">{{ h }}</option>
            {% endfor %}
          </select>
        </div>

        <div id="fund_delim_wrap" style="margin-top:8px;">
          <label>Account delimiter</label><br>
          <input type="text" name="fund_delimiter" value="-" style="width:80px;">
        </div>
      </div>
    </div>

    <hr style="margin:16px 0;">

    <div class="row">
      <div class="col">
        <label><b>Amount format</b></label><br>
        <select name="amount_mode" id="amount_mode" required>
          <option value="signed" selected>Total Balance Column (Debit, (Credit))</option>
          <option value="dc">Separate Debit / Credit columns</option>
        </select>
      </div>

      <div class="col" id="signed_wrap">
        <label><b>Total balance column</b></label><br>
        <select name="balance_col" required>
          <option value="" selected>(select)</option>
          {% for h in headers %}
            <option value="{{ h }}">{{ h }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col" id="dc_wrap" style="display:none;">
        <label><b>Debit column</b></label><br>
        <select name="debit_col" required>
          <option value="" selected>(select)</option>
          {% for h in headers %}
            <option value="{{ h }}">{{ h }}</option>
          {% endfor %}
        </select>

        <div style="height:10px;"></div>

        <label><b>Credit column</b></label><br>
        <select name="credit_col" required>
          <option value="" selected>(select)</option>
          {% for h in headers %}
            <option value="{{ h }}">{{ h }}</option>
          {% endfor %}
        </select>

        <div id="credit_sign_wrap" style="margin-top:10px;">
          <label><b>Credit sign handling</b></label><br>
          <select name="credit_sign_mode" required>
            <option value="keep" selected>Keep Sign (typical: credits are positive numbers)</option>
            <option value="reverse">Reverse Sign (use if credits are stored as negative)</option>
          </select>
          <div style="font-size:12px; opacity:.8; margin-top:6px;">
            This only affects the Credit column. We compute: <b>amount = debit - credit</b>.
          </div>
        </div>
      </div>
    </div>

    <br>
    <button class="btn btn-primary" type="submit">Validate</button>
    <a class="btn" href="/">Start Over</a>
  </form>
</div>

<script>
  function syncAmountUI() {
    const mode = document.getElementById("amount_mode").value;

    document.getElementById("signed_wrap").style.display = (mode === "signed") ? "block" : "none";
    document.getElementById("dc_wrap").style.display = (mode === "dc") ? "block" : "none";

    // If signed, the balance_col must be required; if dc, debit/credit required
    const balance = document.querySelector('select[name="balance_col"]');
    const debit = document.querySelector('select[name="debit_col"]');
    const credit = document.querySelector('select[name="credit_col"]');

    if (balance) balance.required = (mode === "signed");
    if (debit) debit.required = (mode === "dc");
    if (credit) credit.required = (mode === "dc");
  }

  function syncFundUI() {
    const mode = document.getElementById("fund_mode").value;
    document.getElementById("fund_col_wrap").style.display = (mode === "fund_column") ? "block" : "none";
    document.getElementById("fund_delim_wrap").style.display = (mode === "fund_from_account_prefix") ? "block" : "none";
  }

  document.getElementById("amount_mode").addEventListener("change", syncAmountUI);
  document.getElementById("fund_mode").addEventListener("change", syncFundUI);

  syncAmountUI();
  syncFundUI();
</script>

{% endblock %}
