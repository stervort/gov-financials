{% extends "base.html" %}
{% block content %}

<div class="card">
  <h2>Select Binder</h2>

  <div class="row">
    <div class="col">
      <label><b>Select Entity</b> (type to search)</label><br>
      <input
        id="entity_input"
        list="entity_list"
        placeholder="Start typingâ€¦"
        style="width: 100%;"
      />
      <datalist id="entity_list">
        {% for c in clients %}
          <option data-id="{{ c.id }}" value="{{ c.client_name }}"></option>
        {% endfor %}
      </datalist>

      <input type="hidden" id="selected_client_id" value="{{ selected_client_id or '' }}">
    </div>

    <div class="col" style="display:flex; align-items:flex-end; gap:10px;">
      <a class="btn btn-primary" href="/entity/new">New Entity</a>
    </div>
  </div>

  <div style="margin-top:14px;">
    {% if selected_entity_name %}
      <p style="margin:0;">
        <b>Entity:</b> {{ selected_entity_name }}
      </p>
    {% else %}
      <p style="margin:0; opacity:.85;">Choose an entity to see its binders.</p>
    {% endif %}
  </div>

  {% if binders and binders|length > 0 %}
    <h3 style="margin-top:14px;">Binders</h3>
    <table>
      <thead>
        <tr>
          <th>Binder</th>
          <th>Period End</th>
          <th style="width:260px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for b in binders %}
          <tr>
            <td>{{ b.binder_label }}</td>
            <td>{{ b.period_end }}</td>
            <td>
              <a class="btn btn-primary" href="/binder/{{ b.binder_id }}/open">Open</a>
              <a class="btn" href="/binder/{{ b.binder_id }}/rollforward">Rollforward</a>
              <a class="btn" href="/binder/{{ b.binder_id }}/delete">Delete</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% elif selected_entity_name %}
    <div class="warn" style="margin-top:12px;">
      No binders found for this entity.
    </div>
  {% endif %}
</div>

<script>
  // Typeahead datalist -> redirect to /?client_id=...
  (function () {
    const input = document.getElementById("entity_input");
    const list = document.getElementById("entity_list");
    const hidden = document.getElementById("selected_client_id");

    // If already selected, display the name in the input
    const selectedId = hidden.value;
    if (selectedId) {
      const opts = list.querySelectorAll("option");
      for (const o of opts) {
        if (o.dataset.id === selectedId) {
          input.value = o.value;
          break;
        }
      }
    }

    input.addEventListener("change", () => {
      const val = input.value;
      let foundId = null;

      const opts = list.querySelectorAll("option");
      for (const o of opts) {
        if (o.value === val) {
          foundId = o.dataset.id;
          break;
        }
      }

      if (foundId) {
        window.location.href = "/?client_id=" + encodeURIComponent(foundId);
      }
    });
  })();
</script>

{% endblock %}
