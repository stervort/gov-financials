{% extends "base.html" %}
{% block content %}

{% set pane_height = "360px" %}

<div class="card">
  <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
    <h2 style="margin:0;">Select Binder</h2>
    <a class="btn btn-primary" href="/entity/new">New Entity</a>
  </div>

  <div class="row" style="margin-top:14px;">
    <!-- LEFT: Entity picker -->
    <div class="col" style="flex:0 0 320px; min-width:280px;">
      <label><b>Entities</b></label>
      <input
        id="entity_search"
        type="text"
        placeholder="Search entitiesâ€¦"
        autocomplete="off"
        style="margin-top:6px;"
      />

      <input type="hidden" id="selected_client_id" value="{{ selected_client_id or '' }}">

      <div
        style="
          margin-top:10px;
          border:1px solid #e7e9f2;
          border-radius:10px;
          overflow:hidden;
          background:#fff;
        "
      >
        <!-- Fixed height window -->
        <div id="entity_list_inner" style="height:{{ pane_height }}; overflow:auto;">
          {% for c in clients %}
            <a
              class="entity-item"
              href="/?client_id={{ c.id }}"
              data-name="{{ c.client_name|lower }}"
              data-id="{{ c.id }}"
              style="
                display:block;
                padding:8px 10px;
                text-decoration:none;
                color:#0b1b33;
                border-bottom:1px solid #f0f2fa;
                font-size:13px;
                line-height:1.25;
              "
            >
              {{ c.client_name }}
            </a>
          {% endfor %}
        </div>

        <div id="entity_no_results" class="muted" style="display:none; padding:10px 12px;">
          No matching entities.
        </div>
      </div>

      <div class="muted" style="margin-top:8px;">
        Showing {{ clients|length }} entities. Click one to view its binders.
      </div>
    </div>

    <!-- RIGHT: Binder list -->
    <div class="col">
      <div style="margin-bottom:10px;">
        {% if selected_entity_name %}
          <p style="margin:0;">
            <b>Entity:</b> {{ selected_entity_name }}
          </p>
        {% else %}
          <p style="margin:0; opacity:.85;">Choose an entity to see its binders.</p>
        {% endif %}
      </div>

      {% if binders and binders|length > 0 %}
        <!-- Fixed height window for binders -->
        <div
          style="
            height:{{ pane_height }};
            overflow:auto;
            border:1px solid #e7e9f2;
            border-radius:10px;
            background:#fff;
          "
        >
          <table style="margin:0; font-size:13px; line-height:1.25;">
            <thead>
              <tr>
                <th style="position:sticky; top:0; background:#f2f4fb; z-index:1;">Binder</th>
                <th style="position:sticky; top:0; background:#f2f4fb; z-index:1;">Period End</th>
                <th style="position:sticky; top:0; background:#f2f4fb; z-index:1; width:260px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for b in binders %}
                <tr>
                  <td>{{ b.binder_label }}</td>
                  <td>{{ b.period_end }}</td>
                  <td>
                    <a class="btn btn-primary" href="/binder/{{ b.binder_id }}/open">Open</a>
                    <a class="btn" href="/binder/{{ b.binder_id }}/rollforward">Rollforward</a>
                    <a class="btn" href="/binder/{{ b.binder_id }}/delete">Delete</a>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="muted" style="margin-top:8px;">
          Showing {{ binders|length }} binders. Scroll to view more.
        </div>

      {% elif selected_entity_name %}
        <div class="warn" style="margin-top:12px;">
          No binders found for this entity.
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  (function () {
    const search = document.getElementById("entity_search");
    const selectedId = document.getElementById("selected_client_id").value;
    const items = Array.from(document.querySelectorAll(".entity-item"));
    const noResults = document.getElementById("entity_no_results");

    if (selectedId) {
      for (const a of items) {
        if (a.dataset.id === selectedId) {
          a.style.background = "#f2f4fb";
          a.style.fontWeight = "600";
          setTimeout(() => a.scrollIntoView({ block: "nearest" }), 0);
          break;
        }
      }
    }

    function applyFilter() {
      const q = (search.value || "").trim().toLowerCase();
      let visibleCount = 0;

      for (const a of items) {
        const name = a.dataset.name || "";
        const show = !q || name.includes(q);
        a.style.display = show ? "block" : "none";
        if (show) visibleCount++;
      }

      noResults.style.display = (visibleCount === 0) ? "block" : "none";
    }

    search.addEventListener("input", applyFilter);

    search.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        search.value = "";
        applyFilter();
      }
    });

    applyFilter();
  })();
</script>

{% endblock %}
